#!/bin/bash
#
# aws-billing - AWS Cost Explorer billing viewer
#
# Shows detailed billing information for the current AWS profile
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"/lib-aws-billing

# Colors
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color
BOLD='\033[1m'
DIM='\033[2m'

# Box drawing characters
BOX_TL="╔"
BOX_TR="╗"
BOX_BL="╚"
BOX_BR="╝"
BOX_H="═"
BOX_V="║"
BOX_ML="╠"
BOX_MR="╣"

# Default values
PERIOD="month"  # month, week, or custom
AWS_PROFILE_OPT=""  # Will be set to "--profile NAME" if specified

# Budget in USD per profile for "% BUDGET" column
get_budget_for_profile() {
    case "$1" in
        busuu-prod) echo 40000 ;;
        busuu-non-prod) echo 7000 ;;
        busuu) echo 25000 ;;
        busuu-sandbox) echo 800 ;;
        chegg-aws-busuu-verbling-nonprod) echo 1200 ;;
        verbling) echo 8000 ;;
        *) echo 0 ;;
    esac
}

# Format: profile|account_id (same as awsp)
AWS_BILLING_PROFILES=(
    "busuu|331868046896"
    "busuu-prod|526745048846"
    "busuu-non-prod|841596778795"
    "busuu-sandbox|543227299426"
    "chegg-aws-busuu-verbling-nonprod|852617132818"
    "verbling|614942315762"
)

list_profiles() {
    local current
    current=$(get_current_profile)
    echo -e "AWS Profiles:\n"
    printf "  %-3s %-35s %s\n" "" "PROFILE" "ACCOUNT_ID"
    printf "  %-3s %-35s %s\n" "" "-------" "----------"
    for entry in "${AWS_BILLING_PROFILES[@]}"; do
        local profile="${entry%%|*}"
        local account_id="${entry##*|}"
        if [[ "$profile" == "$current" ]]; then
            printf "  ${GREEN}*${NC} ${YELLOW}%-35s${NC} %s\n" "$profile" "$account_id"
        else
            printf "    %-35s %s\n" "$profile" "$account_id"
        fi
    done
}

show_help() {
    echo -e "${BOLD}Usage:${NC} aws-billing [OPTIONS]"
    echo ""
    echo "Display AWS billing costs for the current profile"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo "  list                List available AWS profiles (current marked with *)"
    echo ""
    echo -e "${BOLD}Options:${NC}"
    echo "  -p, --profile NAME    AWS profile to use (default: current AWS_PROFILE)"
    echo "  -m, --mtd             Month-to-date costs (default)"
    echo "  -w, --week            Last 7 days costs"
    echo "  -y, --yesterday       Yesterday's costs"
    echo "  -d, --days N          Last N days costs"
    echo "  -f, --forecast        Include month-end forecast"
    echo "  -e, --ec2             Show detailed EC2 breakdown (default: enabled)"
    echo "  --no-ec2              Hide detailed EC2 breakdown"
    echo "  --no-rds              Hide detailed RDS breakdown"
    echo "  --show-all            Show all services (including under \$1, no top limit)"
    echo "  -t, --top N           Show top N services (default: 15)"
    echo "  --threshold N         Emit warning to stderr when total % of budget >= N (e.g. 70)"
    echo "  --simple-output       Use simple box characters (┌ │ ─) for better display in CI/bots"
    echo "  -h, --help            Show this help message"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  aws-billing                     # Show help"
    echo "  aws-billing list                # List available profiles"
    echo "  aws-billing -p busuu-prod       # Show costs for busuu-prod profile"
    echo "  aws-billing -p busuu-sandbox -w # Show last 7 days for sandbox"
    echo "  aws-billing -d 30               # Show last 30 days"
    echo "  aws-billing -f                  # Include forecast"
    echo "  aws-billing --no-ec2            # Hide EC2 breakdown"
    echo "  aws-billing --no-rds            # Hide RDS breakdown"
    echo "  aws-billing --show-all          # Show all services (including under \$1)"
    echo "  aws-billing --simple-output     # Use simple box chars (e.g. for GitHub comments)"
}

print_header() {
    local title="$1"
    local width=70
    local padding=$(( (width - ${#title} - 2) / 2 ))
    
    echo ""
    echo -e "${CYAN}${BOX_TL}$(printf '%*s' $width '' | tr ' ' "$BOX_H")${BOX_TR}${NC}"
    echo -e "${CYAN}${BOX_V}${NC}$(printf '%*s' $padding '')${BOLD}${WHITE} $title ${NC}$(printf '%*s' $((width - padding - ${#title} - 2)) '')${CYAN}${BOX_V}${NC}"
    echo -e "${CYAN}${BOX_BL}$(printf '%*s' $width '' | tr ' ' "$BOX_H")${BOX_BR}${NC}"
}

print_separator() {
    local width="${1:-72}"
    local char="${SEPARATOR_CHAR:-─}"
    echo -e "${GRAY}$(printf '%*s' "$width" '' | tr ' ' "$char")${NC}"
}

format_currency() {
    local amount="$1"
    printf "$%.2f" "$amount"
}

get_current_profile() {
    # Check for AWS_PROFILE environment variable first
    if [[ -n "$AWS_PROFILE" ]]; then
        echo "$AWS_PROFILE"
    elif [[ -n "$AWS_DEFAULT_PROFILE" ]]; then
        echo "$AWS_DEFAULT_PROFILE"
    else
        echo "default"
    fi
}

get_account_info() {
    local account_id
    local account_alias
    
    account_id=$(aws $AWS_PROFILE_OPT sts get-caller-identity --query 'Account' --output text 2>/dev/null)
    if [[ $? -ne 0 ]]; then
        echo ""
        return 1
    fi
    
    # Try to get account alias
    account_alias=$(aws $AWS_PROFILE_OPT iam list-account-aliases --query 'AccountAliases[0]' --output text 2>/dev/null)
    if [[ "$account_alias" == "None" ]] || [[ -z "$account_alias" ]]; then
        account_alias=""
    fi
    
    echo "$account_id|$account_alias"
}

calculate_dates() {
    local period="$1"
    local start_date end_date
    
    case "$period" in
        month|mtd)
            start_date=$(date -v1d +%Y-%m-%d 2>/dev/null || date -d "$(date +%Y-%m-01)" +%Y-%m-%d)
            end_date=$(date +%Y-%m-%d)
            ;;
        week)
            start_date=$(date -v-7d +%Y-%m-%d 2>/dev/null || date -d "7 days ago" +%Y-%m-%d)
            end_date=$(date +%Y-%m-%d)
            ;;
        yesterday)
            start_date=$(date -v-1d +%Y-%m-%d 2>/dev/null || date -d "yesterday" +%Y-%m-%d)
            end_date=$(date +%Y-%m-%d)
            ;;
        *)
            # Assume it's a number of days
            if [[ "$period" =~ ^[0-9]+$ ]]; then
                start_date=$(date -v-${period}d +%Y-%m-%d 2>/dev/null || date -d "${period} days ago" +%Y-%m-%d)
                end_date=$(date +%Y-%m-%d)
            else
                echo "Invalid period: $period" >&2
                return 1
            fi
            ;;
    esac
    
    echo "$start_date|$end_date"
}

get_costs_by_service() {
    local start_date="$1"
    local end_date="$2"
    
    aws $AWS_PROFILE_OPT ce get-cost-and-usage \
        --time-period Start="$start_date",End="$end_date" \
        --granularity MONTHLY \
        --metrics "UnblendedCost" \
        --group-by Type=DIMENSION,Key=SERVICE \
        --output json 2>/dev/null
}

get_total_cost() {
    local start_date="$1"
    local end_date="$2"
    
    aws $AWS_PROFILE_OPT ce get-cost-and-usage \
        --time-period Start="$start_date",End="$end_date" \
        --granularity MONTHLY \
        --metrics "UnblendedCost" \
        --output json 2>/dev/null
}

get_forecast() {
    local start_date end_date
    
    # Forecast from today to end of month
    start_date=$(date +%Y-%m-%d)
    # Get last day of current month
    end_date=$(date -v1d -v+1m -v-1d +%Y-%m-%d 2>/dev/null || date -d "$(date +%Y-%m-01) +1 month -1 day" +%Y-%m-%d)
    
    # Add one day to end_date for the API (it's exclusive)
    end_date=$(date -j -v+1d -f "%Y-%m-%d" "$end_date" +%Y-%m-%d 2>/dev/null || date -d "$end_date +1 day" +%Y-%m-%d)
    
    aws $AWS_PROFILE_OPT ce get-cost-forecast \
        --time-period Start="$start_date",End="$end_date" \
        --metric UNBLENDED_COST \
        --granularity MONTHLY \
        --output json 2>/dev/null
}

get_ec2_compute_breakdown() {
    local start_date="$1"
    local end_date="$2"
    
    aws $AWS_PROFILE_OPT ce get-cost-and-usage \
        --time-period Start="$start_date",End="$end_date" \
        --granularity MONTHLY \
        --metrics "UnblendedCost" \
        --filter '{"Dimensions": {"Key": "SERVICE", "Values": ["Amazon Elastic Compute Cloud - Compute"]}}' \
        --group-by Type=DIMENSION,Key=USAGE_TYPE \
        --output json 2>/dev/null
}

get_ec2_other_breakdown() {
    local start_date="$1"
    local end_date="$2"
    
    aws $AWS_PROFILE_OPT ce get-cost-and-usage \
        --time-period Start="$start_date",End="$end_date" \
        --granularity MONTHLY \
        --metrics "UnblendedCost" \
        --filter '{"Dimensions": {"Key": "SERVICE", "Values": ["EC2 - Other"]}}' \
        --group-by Type=DIMENSION,Key=USAGE_TYPE \
        --output json 2>/dev/null
}

get_rds_breakdown() {
    local start_date="$1"
    local end_date="$2"
    
    aws $AWS_PROFILE_OPT ce get-cost-and-usage \
        --time-period Start="$start_date",End="$end_date" \
        --granularity MONTHLY \
        --metrics "UnblendedCost" \
        --filter '{"Dimensions": {"Key": "SERVICE", "Values": ["Amazon Relational Database Service"]}}' \
        --group-by Type=DIMENSION,Key=USAGE_TYPE \
        --output json 2>/dev/null
}

display_ec2_breakdown() {
    local json_data="$1"
    local ec2_total="$2"
    local breakdown_title="$3"
    
    if [[ -z "$json_data" ]] || [[ "$json_data" == "null" ]]; then
        return
    fi
    
    local categorized_data
    categorized_data=$(echo "$json_data" | python3 "$SCRIPT_DIR/ec2_breakdown.py" 2>/dev/null)
    
    if [[ -z "$categorized_data" ]]; then
        return
    fi
    
    local hchar="${SEPARATOR_CHAR:-─}"
    # Align with main table: "  │   " (6) + category (36) = 42, then space = cost at 43 (same as main)
    local cat_width=36
    echo -e "  ${CYAN}┌${hchar} ${BOLD}${breakdown_title}${NC}"
    
    while IFS='|' read -r cost category; do
        local percentage
        percentage=$(echo "scale=2; ($cost / $ec2_total) * 100" | bc 2>/dev/null || echo "0")
        local color
        color=$(color_for_cost "$cost")
        
        local bar_width=12
        local filled=$(echo "scale=0; ($percentage * $bar_width) / 100" | bc)
        if (( $(echo "$percentage > 1" | bc -l) )) && [[ $filled -lt 1 ]]; then
            filled=1
        fi
        if [[ $filled -gt $bar_width ]]; then filled=$bar_width; fi
        if [[ $filled -lt 0 ]]; then filled=0; fi
        
        local bar=""
        for ((i=0; i<filled; i++)); do bar+="▓"; done
        for ((i=filled; i<bar_width; i++)); do bar+="░"; done
        
        local display_cat="$category"
        if [[ ${#display_cat} -gt $cat_width ]]; then
            display_cat="${display_cat:0:$((cat_width-3))}..."
        fi
        
        printf "  ${CYAN}│${NC}   %-36s ${color}%12.2f${NC} %6.1f%%  ${MAGENTA}%s${NC}\n" "$display_cat" "$cost" "$percentage" "$bar"
        
    done <<< "$categorized_data"
    
    echo -e "  ${CYAN}└$(printf '%76s' '' | tr ' ' "$hchar")┘${NC}"
}

display_rds_breakdown() {
    local json_data="$1"
    local rds_total="$2"
    local breakdown_title="$3"
    
    if [[ -z "$json_data" ]] || [[ "$json_data" == "null" ]]; then
        return
    fi
    
    local categorized_data
    categorized_data=$(echo "$json_data" | python3 "$SCRIPT_DIR/rds_breakdown.py" 2>/dev/null)
    
    if [[ -z "$categorized_data" ]]; then
        return
    fi
    
    local hchar="${SEPARATOR_CHAR:-─}"
    local cat_width=36
    echo -e "  ${CYAN}┌${hchar} ${BOLD}${breakdown_title}${NC}"
    
    while IFS='|' read -r cost category; do
        local percentage
        percentage=$(echo "scale=2; ($cost / $rds_total) * 100" | bc 2>/dev/null || echo "0")
        local color
        color=$(color_for_cost "$cost")
        
        local bar_width=12
        local filled=$(echo "scale=0; ($percentage * $bar_width) / 100" | bc)
        if (( $(echo "$percentage > 1" | bc -l) )) && [[ $filled -lt 1 ]]; then
            filled=1
        fi
        if [[ $filled -gt $bar_width ]]; then filled=$bar_width; fi
        if [[ $filled -lt 0 ]]; then filled=0; fi
        
        local bar=""
        for ((i=0; i<filled; i++)); do bar+="▓"; done
        for ((i=filled; i<bar_width; i++)); do bar+="░"; done
        
        local display_cat="$category"
        if [[ ${#display_cat} -gt $cat_width ]]; then
            display_cat="${display_cat:0:$((cat_width-3))}..."
        fi
        
        printf "  ${CYAN}│${NC}   %-36s ${color}%12.2f${NC} %6.1f%%  ${MAGENTA}%s${NC}\n" "$display_cat" "$cost" "$percentage" "$bar"
        
    done <<< "$categorized_data"
    
    echo -e "  ${CYAN}└$(printf '%76s' '' | tr ' ' "$hchar")┘${NC}"
}

color_for_cost() {
    local cost="$1"
    local threshold_low=10
    local threshold_med=100
    local threshold_high=500
    
    if (( $(echo "$cost < $threshold_low" | bc -l) )); then
        echo "$GREEN"
    elif (( $(echo "$cost < $threshold_med" | bc -l) )); then
        echo "$YELLOW"
    elif (( $(echo "$cost < $threshold_high" | bc -l) )); then
        echo "$MAGENTA"
    else
        echo "$RED"
    fi
}

create_bar() {
    local percentage="$1"
    local width=12
    
    # Calculate filled blocks based on percentage (0-100)
    # Multiply first, then divide to avoid truncation issues with bc
    local filled=$(echo "scale=0; ($percentage * $width) / 100" | bc)
    
    # Ensure at least 1 block if percentage > 0.5%
    if (( $(echo "$percentage > 0.5" | bc -l) )) && [[ $filled -lt 1 ]]; then
        filled=1
    fi
    
    if [[ $filled -gt $width ]]; then
        filled=$width
    fi
    if [[ $filled -lt 0 ]]; then
        filled=0
    fi
    
    local bar=""
    for ((i=0; i<filled; i++)); do
        bar+="█"
    done
    for ((i=filled; i<width; i++)); do
        bar+="░"
    done
    
    echo "$bar"
}

display_costs() {
    local json_data="$1"
    local top_n="$2"
    local start_date="$3"
    local end_date="$4"
    local show_ec2_details="$5"
    local profile="${6:-}"
    local show_all="${7:-false}"
    local show_rds_details="${8:-true}"
    local threshold="${9:-0}"
    local budget
    budget=$(get_budget_for_profile "$profile")
    if [[ -z "$budget" ]] || [[ "$budget" -eq 0 ]]; then
        budget=1
    fi
    local total_cost=0
    
    # Parse and sort services by cost (only show services > \$1 unless --show-all; count the rest for message)
    if [[ "$show_all" == true ]]; then
        export SHOW_ALL=1
    else
        unset SHOW_ALL 2>/dev/null || true
    fi
    local python_output
    python_output=$(echo "$json_data" | python3 "$SCRIPT_DIR/services_parse.py" 2>/dev/null)
    unset SHOW_ALL 2>/dev/null || true

    local services
    local under_1_count=0
    if [[ -n "$python_output" ]]; then
        under_1_count=$(echo "$python_output" | head -1 | sed 's/UNDER_1_COUNT://')
        services=$(echo "$python_output" | tail -n +2)
    fi

    if [[ -z "$services" ]]; then
        echo -e "${YELLOW}No cost data found for this period${NC}"
        return
    fi
    
    # Calculate total (only from displayed services, i.e. > \$1)
    total_cost=$(echo "$services" | awk -F'|' '{sum += $1} END {print sum}')
    
    # Print header: SERVICE(40) COST(12) "% DISTRIBUTION"(29) "% BUDGET"(30)
    echo ""
    printf "  ${BOLD}%-40s %12s %21s %22s${NC}\n" "SERVICE" "COST (USD)" "% DISTRIBUTION" "% BUDGET"
    print_separator 102
    
    # Print services (all if show_all, else top_n)
    local count=0
    while IFS='|' read -r cost service; do
        if [[ "$show_all" != true ]] && [[ $count -ge $top_n ]]; then
            break
        fi
        
        local percentage
        percentage=$(echo "scale=2; ($cost / $total_cost) * 100" | bc)
        local pct_budget
        pct_budget=$(echo "scale=2; ($cost / $budget) * 100" | bc)
        local color
        color=$(color_for_cost "$cost")
        local bar
        bar=$(create_bar "$percentage")
        local bar_pct_budget="$pct_budget"
        if (( $(echo "$pct_budget > 100" | bc -l 2>/dev/null) )); then
            bar_pct_budget="100"
        fi
        local bar_budget
        bar_budget=$(create_bar "$bar_pct_budget")
        
        # Store original service name for EC2 check
        local original_service="$service"
        
        # Truncate service name if too long
        if [[ ${#service} -gt 38 ]]; then
            service="${service:0:35}..."
        fi
        
        printf "  %-40s ${color}%12.2f${NC} %6.1f%%  ${BLUE}%s${NC}  %6.1f%%  ${BLUE}%s${NC}\n" "$service" "$cost" "$percentage" "$bar" "$pct_budget" "$bar_budget"
        
        # Show EC2-Other breakdown (NAT Gateway, EBS, etc.)
        if [[ "$original_service" == "EC2 - Other" ]] && [[ "$show_ec2_details" == true ]]; then
            local ec2_other_data
            ec2_other_data=$(get_ec2_other_breakdown "$start_date" "$end_date")
            display_ec2_breakdown "$ec2_other_data" "$cost" "EC2 - Other Breakdown"
        fi
        
        # Show EC2-Compute breakdown (instances)
        if [[ "$original_service" == "Amazon Elastic Compute Cloud - Compute" ]] && [[ "$show_ec2_details" == true ]]; then
            local ec2_compute_data
            ec2_compute_data=$(get_ec2_compute_breakdown "$start_date" "$end_date")
            display_ec2_breakdown "$ec2_compute_data" "$cost" "Amazon Elastic Compute Cloud - Compute Breakdown"
        fi
        
        # Show RDS breakdown (by usage type: instance, storage, backup, I/O, etc.)
        if [[ "$original_service" == "Amazon Relational Database Service" ]] && [[ "$show_rds_details" == true ]]; then
            local rds_data
            rds_data=$(get_rds_breakdown "$start_date" "$end_date")
            display_rds_breakdown "$rds_data" "$cost" "RDS Breakdown"
        fi
        
        ((count++))
    done <<< "$services"
    
    # Show count of services with less than \$1 spent (not displayed, unless --show-all)
    if [[ "$show_all" != true ]] && [[ -n "$under_1_count" ]] && [[ "$under_1_count" -gt 0 ]]; then
        echo -e "  ${DIM}... and $under_1_count more services with less than \$1 spent${NC}"
    fi
    
    # Print total
    print_separator 102
    local total_color
    total_color=$(color_for_cost "$total_cost")
    local total_pct_budget
    total_pct_budget=$(echo "scale=2; ($total_cost / $budget) * 100" | bc)
    local total_bar_pct="$total_pct_budget"
    if (( $(echo "$total_pct_budget > 100" | bc -l 2>/dev/null) )); then
        total_bar_pct="100"
    fi
    local total_bar_budget
    total_bar_budget=$(create_bar "$total_bar_pct")
    printf "  ${BOLD}%-40s${NC} ${total_color}${BOLD}%12.2f${NC} %6.1f%%  ${BLUE}%s${NC}  %6.1f%%  ${BLUE}%s${NC}\n" "TOTAL" "$total_cost" "100.0" "$(create_bar 100)" "$total_pct_budget" "$total_bar_budget"

    if [[ -n "$threshold" ]] && [[ "$threshold" -gt 0 ]] && [[ -n "$total_pct_budget" ]]; then
        if (( $(echo "$total_pct_budget >= $threshold" | bc -l 2>/dev/null) )); then
            echo -e "\n  ${YELLOW}WARNING:${NC} exceeded ${threshold}% of the budget" >&2
        fi
    fi
}

display_forecast() {
    local forecast_json="$1"
    
    if [[ -z "$forecast_json" ]] || [[ "$forecast_json" == "null" ]]; then
        echo -e "  ${YELLOW}Forecast unavailable${NC}"
        return
    fi
    
    local forecast_output
    forecast_output=$(echo "$forecast_json" | python3 "$SCRIPT_DIR/forecast.py" 2>/dev/null)
    local forecast_amount prediction_low prediction_high
    forecast_amount=$(echo "$forecast_output" | sed -n '1p')
    prediction_low=$(echo "$forecast_output" | sed -n '2p')
    prediction_high=$(echo "$forecast_output" | sed -n '3p')
    
    echo ""
    echo -e "  ${BOLD}Month-End Forecast:${NC}"
    local color
    color=$(color_for_cost "$forecast_amount")
    echo -e "  Predicted Total: ${color}${BOLD}\$${forecast_amount}${NC}"
    if [[ "$prediction_low" != "0.00" ]] && [[ "$prediction_high" != "0.00" ]]; then
        echo -e "  ${DIM}Range: \$${prediction_low} - \$${prediction_high}${NC}"
    fi
}

# Main execution
main() {
    local period="month"
    local show_forecast=false
    local show_ec2_details=true
    local show_rds_details=true
    local top_n=30
    local custom_profile=""
    local simple_output=false
    local show_all=false
    local threshold=0

    # No args: show help
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi
    
    # "list" subcommand: show profiles and exit
    if [[ "$1" == "list" ]]; then
        list_profiles
        exit 0
    fi
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -p|--profile)
                custom_profile="$2"
                AWS_PROFILE_OPT="--profile $2"
                shift 2
                ;;
            -m|--mtd)
                period="month"
                shift
                ;;
            -w|--week)
                period="week"
                shift
                ;;
            -y|--yesterday)
                period="yesterday"
                shift
                ;;
            -d|--days)
                period="$2"
                shift 2
                ;;
            -f|--forecast)
                show_forecast=true
                shift
                ;;
            -e|--ec2)
                show_ec2_details=true
                shift
                ;;
            --no-ec2)
                show_ec2_details=false
                shift
                ;;
            --no-rds)
                show_rds_details=false
                shift
                ;;
            --show-all)
                show_all=true
                shift
                ;;
            -t|--top)
                top_n="$2"
                shift 2
                ;;
            --simple-output)
                simple_output=true
                shift
                ;;
            --threshold)
                threshold="$2"
                shift 2
                ;;
            *)
                echo -e "${RED}Unknown option:${NC} $1"
                show_help
                exit 1
                ;;
        esac
    done
    
    # Simple: ┌ │ └ etc. para bordes; "-" para líneas largas (muchos ─ no renderizan en GH)
    if [[ "$simple_output" == true ]]; then
        BOX_TL="┌"
        BOX_TR="┐"
        BOX_BL="└"
        BOX_BR="┘"
        BOX_V="│"
        BOX_ML="├"
        BOX_MR="┤"
        BOX_H="-"
        SEPARATOR_CHAR="-"
    fi

    # Get current profile and account info
    local profile
    if [[ -n "$custom_profile" ]]; then
        profile="$custom_profile"
    else
        profile=$(get_current_profile)
    fi
    
    echo -e "\n${BOLD}${CYAN} AWS Billing Dashboard${NC}"
    echo ""
    
    echo -e "  ${BOLD}Profile:${NC}     ${YELLOW}$profile${NC}"
    
    local account_info
    account_info=$(get_account_info)
    
    if [[ -z "$account_info" ]]; then
        echo -e "\n  ${RED}✗ Error:${NC} Failed to authenticate with AWS"
        echo -e "  ${DIM}Make sure you have valid credentials for profile '$profile'${NC}"
        echo -e "  ${DIM}Try running 'auth' first to authenticate${NC}\n"
        exit 1
    fi
    
    IFS='|' read -r account_id account_alias <<< "$account_info"
    echo -e "  ${BOLD}Account:${NC}     ${WHITE}$account_id${NC}"

    local budget
    budget=$(get_budget_for_profile "$profile")
    echo -e "  ${BOLD}Budget:${NC}      \$${budget}"
    
    # Calculate date range
    local dates
    dates=$(calculate_dates "$period")
    IFS='|' read -r start_date end_date <<< "$dates"
    
    echo -e "  ${BOLD}Period:${NC}      $start_date → $end_date"
    
    print_header "Cost Breakdown by Service"
    
    # Fetch and display costs
    local cost_data
    cost_data=$(get_costs_by_service "$start_date" "$end_date")
    
    if [[ -z "$cost_data" ]]; then
        echo -e "\n  ${RED}✗ Error:${NC} Failed to fetch cost data"
        echo -e "  ${DIM}Make sure Cost Explorer is enabled in your account${NC}\n"
        exit 1
    fi
    
    display_costs "$cost_data" "$top_n" "$start_date" "$end_date" "$show_ec2_details" "$profile" "$show_all" "$show_rds_details" "$threshold"
    
    # Show forecast if requested
    if [[ "$show_forecast" == true ]]; then
        print_header "Forecast"
        local forecast_data
        forecast_data=$(get_forecast)
        display_forecast "$forecast_data"
    fi
    
    echo ""
}

main "$@"
