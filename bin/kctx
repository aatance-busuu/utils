#!/bin/bash
#
# kctx - Kubernetes context switcher
#

# Colors
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Define contexts: alias|actual_context|description
declare -a CONTEXTS=(
    "busuu-prod|busuu-prod-blue|Busuu Production (Blue)"
    "busuu-non-prod-blue|busuu-non-prod-blue|Busuu Non-Prod (Blue)"
    "busuu-non-prod-green|busuu-non-prod-green|Busuu Non-Prod (Green)"
    "busuu-sandbox|busuu-sandbox-blue|Busuu Sandbox (Blue)"
    "verbling-us|verbling-prod-us-east-1|Verbling Prod US (us-east-1)"
    "verbling-eu|verbling-prod-eu-west-1|Verbling Prod EU (eu-west-1)"
    "chegg-verbling|chegg-verbling-non-prod|Chegg Verbling Non-Prod"
)

show_help() {
    echo -e "${BOLD}Usage:${NC} kctx [CONTEXT]"
    echo ""
    echo "Kubernetes context switcher with friendly aliases"
    echo ""
    echo -e "${BOLD}Options:${NC}"
    echo "  -h, --help      Show this help message"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  kctx              # List contexts (current marked with *)"
    echo "  kctx busuu-prod   # Switch to busuu-prod"
}

get_current_context() {
    kubectl config current-context 2>/dev/null
}

list_contexts() {
    local current=$(get_current_context)
    
    echo -e "${BOLD}Kubernetes Contexts:${NC}\n"
    printf "  ${BOLD}%-3s %-25s %-30s %s${NC}\n" "" "ALIAS" "CONTEXT" "DESCRIPTION"
    printf "  %-3s %-25s %-30s %s\n" "" "-----" "-------" "-----------"
    
    for entry in "${CONTEXTS[@]}"; do
        IFS='|' read -r alias context description <<< "$entry"
        
        if [[ "$context" == "$current" ]]; then
            printf "  ${GREEN}*${NC} ${YELLOW}%-25s${NC} %-30s ${CYAN}%s${NC}\n" "$alias" "$context" "$description"
        else
            printf "    %-25s %-30s ${CYAN}%s${NC}\n" "$alias" "$context" "$description"
        fi
    done
}

show_current() {
    local current=$(get_current_context)
    
    if [[ -z "$current" ]]; then
        echo -e "${RED}No current context set${NC}"
        return 1
    fi
    
    # Find the alias for the current context
    local alias_name=""
    local description=""
    for entry in "${CONTEXTS[@]}"; do
        IFS='|' read -r a c d <<< "$entry"
        if [[ "$c" == "$current" ]]; then
            alias_name="$a"
            description="$d"
            break
        fi
    done
    
    if [[ -n "$alias_name" ]]; then
        echo -e "${BOLD}Alias:${NC}       ${YELLOW}$alias_name${NC}"
    fi
    echo -e "${BOLD}Context:${NC}     $current"
    if [[ -n "$description" ]]; then
        echo -e "${BOLD}Description:${NC} ${CYAN}$description${NC}"
    fi
}

switch_context() {
    local target="$1"
    
    # Check if it's an alias
    for entry in "${CONTEXTS[@]}"; do
        IFS='|' read -r alias context description <<< "$entry"
        if [[ "$alias" == "$target" ]]; then
            if kubectl config use-context "$context" > /dev/null 2>&1; then
                echo -e "Switched k8s context to: ${YELLOW}$alias${NC}"
                return 0
            else
                echo -e "${RED}Error:${NC} Failed to switch context"
                return 1
            fi
        fi
    done
    
    # Maybe it's a direct context name - find its alias if exists
    if kubectl config get-contexts -o name 2>/dev/null | grep -q "^${target}$"; then
        if kubectl config use-context "$target" > /dev/null 2>&1; then
            # Try to find the alias for this context
            local display_name="$target"
            for entry in "${CONTEXTS[@]}"; do
                IFS='|' read -r alias context description <<< "$entry"
                if [[ "$context" == "$target" ]]; then
                    display_name="$alias"
                    break
                fi
            done
            echo -e "Switched k8s context to: ${YELLOW}$display_name${NC}"
            return 0
        else
            echo -e "${RED}Error:${NC} Failed to switch context"
            return 1
        fi
    fi
    
    echo -e "${RED}Error:${NC} Context '$target' not found."
    echo ""
    list_contexts
    return 1
}

# Parse arguments
case "$1" in
    -h|--help)
        show_help
        ;;
    "")
        list_contexts
        ;;
    -*)
        echo -e "${RED}Unknown option:${NC} $1"
        show_help
        exit 1
        ;;
    *)
        switch_context "$1"
        ;;
esac
